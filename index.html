<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <!-- Removed viewport restriction that might hinder zooming -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบสำรวจภาคสนาม</title>
  <link rel="icon" href="static/icons/lb.ico" type="image/x-icon">
  <link rel="manifest" href="manifest.json">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Tahoma, Arial, sans-serif; /* Use Tahoma font */
      font-size: 10px; /* Set base font size to 10px */
      background-color: #f0f0f0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      /* Hardware acceleration */
      transform: translate3d(0, 0, 0);
      will-change: transform;
      /* Ensure touch events work for zooming on mobile */
      touch-action: auto !important;
    }

    /* Crosshair Styling */
    #crosshair {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none; /* Allow clicks to pass through */
      z-index: 500; /* High enough to be on top of map controls but below panels */
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #crosshair.hidden {
        opacity: 0;
        visibility: hidden;
    }
    #crosshair.visible {
        opacity: 1;
        visibility: visible;
    }

    .crosshair-line {
      position: absolute;
      background-color: rgba(255, 0, 0, 0.7); /* Red lines */
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5); /* Slight shadow */
    }
    .horizontal {
      width: 60px; /* Length of horizontal line */
      height: 2px;
      top: -1px; /* Center on crosshair center */
      left: -30px; /* Center on crosshair center */
    }
    .vertical {
      width: 2px;
      height: 60px; /* Length of vertical line */
      top: -30px; /* Center on crosshair center */
      left: -1px; /* Center on crosshair center */
    }

    .crosshair-circle {
      position: absolute;
      width: 60px;
      height: 60px;
      border: 2px solid rgba(255, 0, 0, 0.7); /* Red circle */
      border-radius: 50%;
      top: -30px; /* Center on crosshair center */
      left: -30px; /* Center on crosshair center */
      box-sizing: border-box;
    }

    /* Add Trigger Container */
    #add-trigger-container {
      position: fixed;
      top: calc(50% + 80px); /* Positioned below the crosshair */
      left: 50%;
      transform: translateX(-50%);
      z-index: 501; /* Slightly higher than crosshair */
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.4s ease; /* Smooth fade and slide up/down */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #add-trigger-container.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(20px); /* Start below */
        visibility: hidden;
    }
    #add-trigger-container.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0); /* Slide up to original position */
        visibility: visible;
    }

    #add-trigger {
      background-color: #f97316; /* Orange background */
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      font-size: 24px; /* Size of the plus sign */
      font-weight: bold;
    }

    #add-trigger:hover {
      background-color: #ea580c; /* Darker orange on hover */
    }

    /* Confirm Overlay */
    #confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent dark background */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* Very high z-index */
      opacity: 0;
      pointer-events: none; /* Initially not interactive */
      transition: opacity 0.3s ease;
    }

    #confirm-overlay.active {
      opacity: 1;
      pointer-events: all; /* Become interactive when active */
    }

    .confirm-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      text-align: center;
      max-width: 90vw;
      width: 400px;
    }

    .confirm-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirm-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .confirm-btn.yes {
      background-color: #22c55e; /* Green */
    }
    .confirm-btn.yes:hover {
      background-color: #16a34a; /* Darker Green */
    }

    .confirm-btn.no {
      background-color: #ef4444; /* Red */
    }
    .confirm-btn.no:hover {
      background-color: #dc2626; /* Darker Red */
    }

    /* Data Table Panel */
    .data-table-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 90%; /* Responsive width */
      max-width: 900px; /* Max width */
      /* Height adjusted for better mobile experience */
      max-height: 47vh; /* ✅ Changed from 60vh to 47vh */
      height: 47vh;     /* ✅ Added this line to give a fixed height of 47% */
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }

    .table-header {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 14px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }

    .table-controls {
      display: flex;
      gap: 8px;
    }

    .table-btn {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .table-btn:hover {
      background-color: #dde0e3;
    }

    .table-btn.active {
      background-color: #0d6efd;
      color: white;
    }

    .table-content {
      flex-grow: 1;
      overflow-y: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #ddd;
      padding: 6px; /* Reduced padding */
      text-align: left;
      font-size: 10px; /* Match body font size */
    }

    .data-table th {
      background-color: #f1f3f4;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .data-table tbody tr:hover {
      background-color: #e9ecef;
    }

    .zoom-btn {
      background-color: #a5d8a9; /* Light green */
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px; /* Shorter width */
      height: 24px; /* Shorter height */
    }
    .zoom-btn:hover {
      background-color: #8bc38e; /* Slightly darker green */
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0;
      right: -450px; /* Hidden initially */
      width: 420px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side-panel.active {
      right: 0; /* Slide in */
    }

    .panel-header {
      background-color: #f8f9fa;
      padding: 12px 15px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 16px;
      font-weight: bold;
      margin: 0;
      color: #495057;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #6c757d;
    }
    .close-btn:hover {
      color: #495057;
    }

    .panel-content {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .form-group {
      margin-bottom: 12px; /* Reduced margin */
    }

    .form-label {
      display: block;
      margin-bottom: 4px; /* Reduced margin */
      font-weight: bold;
      color: #495057;
      font-size: 11px; /* Slightly smaller label */
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 6px 8px; /* Smaller padding */
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 10px; /* Match body font size */
      box-sizing: border-box;
    }

    .form-textarea {
        resize: vertical;
        min-height: 60px;
    }

    .form-row {
        display: flex;
        gap: 10px;
    }

    .form-row .form-group {
        flex: 1;
        margin-bottom: 0; /* Remove bottom margin for items in a row */
    }

    .save-btn {
        background-color: #90ee90; /* Light green */
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        color: black; /* Default text color */
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        margin-top: 10px;
    }
    .save-btn:hover {
        background-color: black; /* Black on hover */
        color: white; /* White text on hover */
    }

    .delete-btn {
        background-color: #dc3545; /* Red */
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 12px;
        margin-top: 5px;
    }
    .delete-btn:hover {
        background-color: #bd2130; /* Darker red on hover */
    }

    .image-preview-container {
        margin-top: 10px;
    }

    .preview-image {
        max-width: 100%;
        max-height: 200px; /* Limit preview height */
        border-radius: 4px;
        object-fit: contain; /* Maintain aspect ratio */
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #007bff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      z-index: 2001;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .notification.success { background-color: #28a745; }
    .notification.error { background-color: #dc3545; }

    /* Edit Mode Modal */
    #edit-mode-modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 2002; /* Higher than other elements */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      border-radius: 8px;
      width: 80%;
      max-width: 400px; /* Max width */
      text-align: center;
    }

    .modal-buttons {
      margin-top: 15px;
    }

    .modal-btn {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-btn.save { background-color: #28a745; color: white; }
    .modal-btn.cancel { background-color: #6c757d; color: white; }

    .modal-btn.save:hover { background-color: #218838; }
    .modal-btn.cancel:hover { background-color: #5a6268; }

    /* Button Styles */
    .app-button {
      background-color: #e2e6ea;
      border: 1px solid #ced4da;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 12px;
      color: #495057;
      transition: background-color 0.2s, color 0.2s;
    }
    .app-button:hover {
      background-color: #dae0e5;
      color: #212529;
    }
    .app-button.active-tool {
        background-color: #f97316; /* Orange when active */
        color: white;
    }
    .app-button.active-edit {
        background-color: #10b981; /* Emerald when edit mode is active */
        color: white;
    }

    .top-right-controls, .bottom-left-controls {
        position: fixed;
        z-index: 1000;
        display: flex;
        gap: 8px;
    }
    .top-right-controls {
        top: 20px;
        right: 20px;
    }
    .bottom-left-controls {
        bottom: calc(20px + 47vh + 20px); /* Account for table panel height and margin */
        left: 20px;
    }

    /* Settings Menu */
    .settings-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    /* Animation Classes */
    .animate-fade-in {
      animation: fadeIn 0.3s forwards;
    }
    .animate-fade-out {
      animation: fadeOut 0.3s forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Hide markers during zoom for performance */
    .leaflet-zoom-anim .circle-marker,
    .leaflet-zoom-anim .crosshair {
        display: none !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .data-table-panel {
            left: 10px;
            right: 10px;
            width: auto;
            bottom: 10px;
        }
        .side-panel {
             width: calc(100% - 20px); /* Nearly full width on small screens */
             max-width: none;
        }
        .top-right-controls, .bottom-left-controls {
             gap: 6px; /* Smaller gap on mobile */
        }
        .app-button {
             padding: 6px 10px; /* Smaller buttons */
             font-size: 11px;
        }
    }

    /* Ensure map container fills the screen */
    #map.leaflet-container {
         touch-action: auto !important; /* Critical for mobile zoom gestures */
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Crosshair -->
  <div id="crosshair" class="hidden">
    <div class="crosshair-line horizontal"></div>
    <div class="crosshair-line vertical"></div>
    <div class="crosshair-circle"></div>
  </div>

  <!-- Add Trigger Button Container -->
  <div id="add-trigger-container" class="hidden">
    <button id="add-trigger">+</button>
  </div>

  <!-- Confirm Overlay -->
  <div id="confirm-overlay" class="hidden">
    <div class="confirm-box">
      <div class="confirm-title" id="confirm-text">ยืนยันการดำเนินการ?</div>
      <div class="confirm-actions">
        <button class="confirm-btn yes" id="btn-confirm-yes">ใช่</button>
        <button class="confirm-btn no" id="btn-confirm-no">ไม่</button>
      </div>
    </div>
  </div>

  <!-- Settings Menu (Gear Icon) -->
  <div class="settings-menu">
      <button id="btn-settings" class="app-button">
          <i data-lucide="settings" class="w-4 h-4"></i>
      </button>
  </div>

  <!-- Top Right Controls -->
  <div class="top-right-controls">
      <button id="btn-building" class="app-button">
          <i data-lucide="home" class="w-4 h-4"></i> สิ่งปลูกสร้าง
      </button>
      <button id="btn-sign" class="app-button">
          <i data-lucide="tag" class="w-4 h-4"></i> ป้าย
      </button>
  </div>

  <!-- Bottom Left Controls -->
  <div class="bottom-left-controls">
      <button id="btn-refresh" class="app-button">
          <i id="refresh-icon" data-lucide="refresh-cw" class="w-4 h-4"></i>
      </button>
      <button id="btn-edit" class="app-button">
          <i data-lucide="pencil" class="w-4 h-4"></i>
      </button>
  </div>

  <!-- Data Table Panel -->
  <div class="data-table-panel" id="data-table-panel">
    <div class="table-header">
        <h3 class="table-title">ข้อมูลภาคสนาม</h3>
        <div class="table-controls">
            <button class="table-btn active" data-type="building">สิ่งปลูกสร้าง</button>
            <button class="table-btn" data-type="sign">ป้าย</button>
            <button class="table-btn" id="btn-export-geojson">GeoJSON</button>
            <button class="table-btn" id="btn-export-sign-geojson">GeoJSON ป้าย</button>
            <button class="table-btn" id="btn-load-images">Load Images</button>
        </div>
    </div>
    <div class="table-content">
        <table class="data-table">
            <thead>
                <tr id="building-table-header">
                    <!-- Headers populated by JS -->
                </tr>
            </thead>
            <tbody id="building-table-body">
                 <!-- Rows populated by JS -->
            </tbody>
        </table>
        <table class="data-table hidden" id="sign-table-container">
            <thead>
                <tr id="sign-table-header">
                    <!-- Headers populated by JS -->
                </tr>
            </thead>
            <tbody id="sign-table-body">
                 <!-- Rows populated by JS -->
            </tbody>
        </table>
    </div>
  </div>

  <!-- Side Panel -->
  <div class="side-panel" id="side-panel">
    <div class="panel-header">
        <h3 class="panel-title" id="panel-title">รายละเอียด</h3>
        <button class="close-btn">&times;</button>
    </div>
    <div class="panel-content" id="panel-content">
        <!-- Content populated by JS -->
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
      <div class="spinner"></div>
  </div>

  <!-- Edit Mode Modal -->
  <div id="edit-mode-modal">
      <div class="modal-content">
          <p>อยู่ในโหมดแก้ไข</p>
          <p>คลิก "บันทึก" เพื่อยืนยันการเปลี่ยนแปลง</p>
          <div class="modal-buttons">
              <button class="modal-btn save" id="btn-save-edits">บันทึก</button>
              <button class="modal-btn cancel" id="btn-cancel-edit">ยกเลิก</button>
          </div>
      </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- Configuration ---
    const CONFIG = {
        SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyJ1DNqz7Uzytm_mjP3bR9RKQYHmM5VzFvCk4rD1GgIfN1sZoLm/exec', // Replace with your Apps Script URL
        // For offline tile caching, the base URL pattern is needed
        TILE_BASE_URLS: [
            'https://mt0.google.com/',
            'https://mt1.google.com/',
            'https://mt2.google.com/',
            'https://mt3.google.com/'
        ]
    };

    // --- Global Variables ---
    let map;
    let surveyLayers; // LayerGroup for markers
    let activeTool = null; // 'building' or 'sign'
    let isEditMode = false;
    let allBuildings = [];
    let allSigns = [];
    let editingMarker = null; // Marker currently being edited in side panel
    let currentTypeFilter = 'building'; // Current table view

    // --- Utility Functions ---
    function showLoading(show) {
        const overlay = document.getElementById('loading-overlay');
        if (show) {
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }

    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function isMobile() {
        return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // --- Map Initialization ---
    function initMap() {
        // Initialize map with canvas rendering and hardware acceleration
        map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            preferCanvas: true // ✅ Enable Canvas Rendering
        }).setView([15.202, 102.068], 14); // Adjusted initial view

        // Multi-resolution tile layers
        const lowResLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 15, // Low resolution up to zoom 15
            opacity: 1.0,
            zIndex: 1,
            // Optimized for performance
            updateWhenIdle: false,
            updateWhenZooming: true,
            keepBuffer: 4,
            reuseTiles: true
            // Note: maxNativeZoom might cause issues if tiles don't exist at high zooms from these sources
            // Consider removing or adjusting based on available tile levels
            // maxNativeZoom: 19 
        });

        const highResLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            minZoom: 16, // High resolution from zoom 16 onwards
            maxZoom: 22, // Max display zoom for this layer
            opacity: 1.0,
            zIndex: 2,
            // Optimized for performance
            updateWhenIdle: false,
            updateWhenZooming: true,
            keepBuffer: 2, // Slightly less buffer for high-res as it's more detailed
            reuseTiles: true
            // Note: maxNativeZoom might cause issues if tiles don't exist at high zooms from these sources
            // Consider removing or adjusting based on available tile levels
            // maxNativeZoom: 19
        });

        // Apply hardware acceleration to map container
        map.getContainer().style.transform = 'translate3d(0, 0, 0)';
        map.getContainer().style.willChange = 'transform';

        lowResLayer.addTo(map);
        highResLayer.addTo(map);

        // Create layer group for markers
        surveyLayers = L.layerGroup().addTo(map);

        // Add layers to map
        surveyLayers.addTo(map);

        // Optional: Adjust settings specifically for mobile if needed, but avoid limiting zoom unnecessarily
        if (isMobile()) {
            // Removed map._limitZoom and map.options.zoomSnap to allow normal zoom behavior on mobile
            // map.options.zoomSnap = 0.5; // This can make zoom feel less smooth
        }
    }


    // --- Marker Functions ---
    function createCircleMarker(latlng, type, draggable = false) {
        const isBuilding = type === 'building';
        const color = isBuilding ? '#f97316' : '#22c55e'; // Orange for building, green for sign
        const radius = isBuilding ? 8 : 6;

        const marker = L.circleMarker(latlng, {
            color: color,
            fillColor: color,
            fillOpacity: 0.8,
            radius: radius,
            className: 'circle-marker' // Add class for potential performance hiding during zoom
        });

        if (draggable) {
            marker.dragging.enable();
        }

        return marker;
    }

    function setupMarkerPopup(marker, data, type) {
        const isBuilding = type === 'building';
        let popupContent = `<b>${isBuilding ? 'สิ่งปลูกสร้าง' : 'ป้าย'}</b><br>`;
        if (isBuilding && data.b_number) popupContent += `No.: ${data.b_number}<br>`;
        if (data.owner_name) popupContent += `เจ้าของ: ${data.owner_name}<br>`;
        if (data.lat_long) popupContent += `พิกัด: ${data.lat_long}`;

        marker.bindPopup(popupContent);
        // Store data reference on marker for later use (e.g., editing)
        marker._popupData = {...data, type: type};
    }

    function enableMarkerDragging(marker, data) {
        if (!isEditMode) return;
        marker.dragging.enable();
        marker.on('dragend', async (e) => {
            const newLatLng = e.target.getLatLng();
            const marker = e.target;
            const data = marker._popupData;
            if (data) {
                await updateMarkerPosition(marker, data, newLatLng);
            }
        });
    }

    async function updateMarkerPosition(marker, data, newLatLng) {
        // Show temporary saving indicator
        const savingMsg = document.createElement('div');
        savingMsg.className = 'fixed top-4 left-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
        savingMsg.textContent = 'กำลังอัปเดตตำแหน่ง...';
        document.body.appendChild(savingMsg);

        try {
            const formData = new FormData();
            formData.append('action', 'updatePosition');
            formData.append('id', data.id || data._row_num); // Use appropriate key
            formData.append('type', data.type);
            formData.append('lat', newLatLng.lat.toFixed(6));
            formData.append('lng', newLatLng.lng.toFixed(6));

            const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
            const result = await res.json();

            if (result.result === 'success') {
                // Update the stored data
                if (data.type === 'building') {
                    const index = allBuildings.findIndex(b => (b.id === data.id || b._row_num === data._row_num));
                    if (index !== -1) allBuildings[index].lat_long = `${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)}`;
                } else { // sign
                    const index = allSigns.findIndex(s => (s.id === data.id || s._row_num === data._row_num));
                    if (index !== -1) allSigns[index].lat_long = `${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)}`;
                }

                // Update marker's stored data reference
                marker._popupData.lat_long = `${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)}`;

                // Update popup content
                setupMarkerPopup(marker, marker._popupData, data.type);

                // Show success notification
                savingMsg.classList.remove('animate-fade-in');
                savingMsg.classList.add('animate-fade-out');
                setTimeout(() => savingMsg.remove(), 300);

                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
                successMsg.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i>อัปเดตตำแหน่งสำเร็จ!';
                document.body.appendChild(successMsg);
                lucide.createIcons({ el: successMsg }); // Icon for success message
                setTimeout(() => {
                    successMsg.classList.add('animate-fade-out');
                    setTimeout(() => successMsg.remove(), 300);
                }, 2000);

                // Reload table to reflect changes
                renderBuildingTable();
                renderSignTable();
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error('Error updating marker position:', err);
            savingMsg.remove();
            showNotification(`เกิดข้อผิดพลาด: ${err.message}`, 'error');
        }
    }


    // --- Tool Activation ---
    function deactivateTools() {
        activeTool = null;
        document.getElementById('btn-building').classList.remove('active-tool');
        document.getElementById('btn-sign').classList.remove('active-tool');

        const crosshair = document.getElementById('crosshair');
        const addTrigger = document.getElementById('add-trigger-container');
        const overlay = document.getElementById('confirm-overlay');

        // Start slide down animation
        crosshair.classList.remove('visible');
        addTrigger.classList.remove('visible');
        overlay.classList.remove('active');

        // After animation completes, hide elements properly
        setTimeout(() => {
            crosshair.classList.add('hidden');
            addTrigger.classList.add('hidden');
            overlay.classList.add('hidden');
        }, 400); // Matches animation duration
    }

    function activateTool(tool) {
        isEditMode = false; // Turn off edit mode when activating capture tools
        document.getElementById('btn-edit').classList.remove('active-edit');
        surveyLayers.eachLayer(l => l.dragging && l.dragging.disable());

        if (activeTool === tool) {
            // Deactivate if the same tool is clicked again
            deactivateTools();
        } else {
            // Activate new tool
            activeTool = tool;
            document.getElementById('btn-building').classList.toggle('active-tool', tool === 'building');
            document.getElementById('btn-sign').classList.toggle('active-tool', tool === 'sign');

            const crosshair = document.getElementById('crosshair');
            const addTrigger = document.getElementById('add-trigger-container');

            // Remove hidden class and add visible class with animation
            crosshair.classList.remove('hidden');
            addTrigger.classList.remove('hidden');
            // Force browser to recalculate before starting animation
            void crosshair.offsetWidth;
            void addTrigger.offsetWidth;

            // Start slide up animation
            crosshair.classList.add('visible');
            addTrigger.classList.add('visible');

            // Hide confirm overlay if present
            document.getElementById('confirm-overlay').classList.add('hidden');
        }
    }


    // --- Capture Flow ---
    function showConfirmOverlay() {
        const overlay = document.getElementById('confirm-overlay');
        const btn = document.getElementById('btn-confirm-action');
        const text = document.getElementById('confirm-text');

        if (activeTool === 'building') {
            btn.style.backgroundColor = '#f97316';
            text.innerText = "ยืนยันเพิ่มสิ่งปลูกสร้าง?";
        } else { // sign
            btn.style.backgroundColor = '#22c55e';
            text.innerText = "ยืนยันเพิ่มป้าย?";
        }
        overlay.classList.remove('hidden');
        overlay.classList.add('active'); // Makes it interactive
    }

    async function confirmCapture() {
        // Calculate coordinates based on crosshair position (slightly higher)
        const containerPoint = L.point(map.getSize().x / 2, map.getSize().y * 0.35); // 35% from top (~where crosshair is)
        const latlng = map.containerPointToLatLng(containerPoint);

        document.getElementById('confirm-overlay').classList.remove('active');
        document.getElementById('confirm-overlay').classList.add('hidden');

        const tempMarker = createCircleMarker(latlng, activeTool);
        tempMarker.addTo(surveyLayers);
        await backgroundUpload(latlng, activeTool, tempMarker); // Wait for upload to complete potentially
    }

    async function backgroundUpload(latlng, type, marker) {
        const refreshBtn = document.getElementById('btn-refresh');
        const refreshIcon = document.getElementById('refresh-icon');

        // Disable refresh button during upload
        refreshBtn.disabled = true;
        refreshBtn.style.opacity = '0.5';
        refreshBtn.style.cursor = 'not-allowed';
        refreshIcon.classList.add('animate-spin');

        // Show temporary saving indicator
        const savingMsg = document.createElement('div');
        savingMsg.className = 'fixed top-4 left-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
        savingMsg.textContent = type === 'building' ? 'กำลังบันทึกสิ่งปลูกสร้าง...' : 'กำลังบันทึกป้าย...';
        document.body.appendChild(savingMsg);

        try {
            const formData = new FormData();
            formData.append('action', 'addData');
            formData.append('type', type);
            formData.append('lat', latlng.lat.toFixed(6));
            formData.append('lng', latlng.lng.toFixed(6));
            // Add other default/fetchable data as needed, e.g., user info from login

            const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
            const result = await res.json();

            if (result.result === 'success') {
                // Update local data store
                const newRow = {
                    id: result.id, // Assuming script returns new ID
                    lat_long: `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`,
                    owner_name: 'รอการกรอก', // Default value
                    // Add other default values as needed
                };
                if (type === 'building') {
                    allBuildings.push(newRow);
                } else {
                    allSigns.push(newRow);
                }

                // Setup popup for the temporary marker using new data
                setupMarkerPopup(marker, newRow, type);
                marker._popupData = {...newRow, type: type}; // Update internal reference

                // Remove temporary marker style, make permanent
                const isBuilding = type === 'building';
                const color = isBuilding ? '#f97316' : '#22c55e';
                marker.setStyle({ color: color, fillColor: color });

                // Show success notification
                savingMsg.classList.remove('animate-fade-in');
                savingMsg.classList.add('animate-fade-out');
                setTimeout(() => savingMsg.remove(), 300);

                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
                successMsg.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i>เพิ่ม${type === 'building' ? 'สิ่งปลูกสร้าง' : 'ป้าย'} สำเร็จ!`;
                document.body.appendChild(successMsg);
                lucide.createIcons({ el: successMsg });
                setTimeout(() => {
                    successMsg.classList.add('animate-fade-out');
                    setTimeout(() => successMsg.remove(), 300);
                }, 2000);

                // Reload table
                renderBuildingTable();
                renderSignTable();

            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error(`Error uploading ${type}:`, err);
            // Remove temporary marker on error
            map.removeLayer(marker);
            savingMsg.remove(); // Remove saving msg
            showNotification(`เพิ่ม${type === 'building' ? 'สิ่งปลูกสร้าง' : 'ป้าย'} ล้มเหลว: ${err.message}`, 'error');
        } finally {
            // Re-enable refresh button
            refreshBtn.disabled = false;
            refreshBtn.style.opacity = '1';
            refreshBtn.style.cursor = 'pointer';
            refreshIcon.classList.remove('animate-spin');
        }
    }


    // --- Data Loading & Table Rendering ---
    async function loadExistingData() {
        showLoading(true);
        try {
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getData`);
            const data = await res.json();
            surveyLayers.clearLayers(); // Clear existing markers

            // Store data globally
            allBuildings = data.buildings || [];
            allSigns = data.signs || [];

            // Render tables
            renderBuildingTable();
            renderSignTable();

            // Create markers on map (simple version, consider optimization for large datasets later if needed)
            allBuildings.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'building', isEditMode);
                setupMarkerPopup(m, r, 'building');
                m.addTo(surveyLayers);
                if (isEditMode) enableMarkerDragging(m, r);
            });

            allSigns.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'sign', isEditMode);
                setupMarkerPopup(m, r, 'sign');
                m.addTo(surveyLayers);
                if (isEditMode) enableMarkerDragging(m, r);
            });

        } catch(e) {
            console.error("Error loading data:", e);
            showNotification('โหลดข้อมูลล้มเหลว: ' + e.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function renderBuildingTable() {
        const tbody = document.getElementById('building-table-body');
        const thead = document.getElementById('building-table-header');
        const shouldShow = currentTypeFilter === 'building';

        // Show/hide table container
        document.getElementById('data-table-panel').classList.toggle('hidden', !shouldShow);
        document.getElementById('sign-table-container').classList.toggle('hidden', shouldShow);

        if (!shouldShow) return; // Don't render if not active

        if (allBuildings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ไม่มีข้อมูลสิ่งปลูกสร้าง</td></tr>';
            thead.innerHTML = '<th>ลำดับ</th><th>เลขที่</th><th>ชื่อเจ้าของ</th><th>พิกัด</th><th>ดำเนินการ</th>';
            return;
        }

        // Define headers (adjust based on your data structure)
        thead.innerHTML = '<th>ลำดับ</th><th>เลขที่</th><th>ชื่อเจ้าของ</th><th>พิกัด</th><th>ดำเนินการ</th>';

        tbody.innerHTML = allBuildings.map((building, index) => {
            if (!building.lat_long) return ''; // Skip invalid entries
            const coords = building.lat_long.split(',');
            const lat = parseFloat(coords[0]);
            const lng = parseFloat(coords[1]);
            if (isNaN(lat) || isNaN(lng)) return ''; // Skip invalid coordinates

            return `
            <tr>
                <td>${index + 1}</td>
                <td>${building.b_number || ''}</td>
                <td>${building.owner_name || ''}</td>
                <td>${building.lat_long}</td>
                <td>
                    <button class="zoom-btn" onclick="zoomToLocation(L.latLng(${lat}, ${lng}))"><i data-lucide="locate" class="w-3 h-3 inline"></i></button>
                    <button class="zoom-btn ml-1" onclick="openEditPanel('building', ${building.id || building._row_num})"><i data-lucide="edit" class="w-3 h-3 inline"></i></button>
                </td>
            </tr>`;
        }).join('');

        // Re-initialize icons after table update
        lucide.createIcons();
    }

    function renderSignTable() {
        const tbody = document.getElementById('sign-table-body');
        const thead = document.getElementById('sign-table-header');
        const shouldShow = currentTypeFilter === 'sign';

        // Show/hide table container
        document.getElementById('data-table-panel').classList.toggle('hidden', !shouldShow);
        document.getElementById('sign-table-container').classList.toggle('hidden', !shouldShow);

        if (!shouldShow) return; // Don't render if not active

        if (allSigns.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ไม่มีข้อมูลป้าย</td></tr>';
            thead.innerHTML = '<th>ลำดับ</th><th>ชื่อป้าย</th><th>รายละเอียด</th><th>พิกัด</th><th>ดำเนินการ</th>';
            return;
        }

        // Define headers (adjust based on your data structure)
        thead.innerHTML = '<th>ลำดับ</th><th>ชื่อป้าย</th><th>รายละเอียด</th><th>พิกัด</th><th>ดำเนินการ</th>';

        tbody.innerHTML = allSigns.map((sign, index) => {
             if (!sign.lat_long) return ''; // Skip invalid entries
            const coords = sign.lat_long.split(',');
            const lat = parseFloat(coords[0]);
            const lng = parseFloat(coords[1]);
            if (isNaN(lat) || isNaN(lng)) return ''; // Skip invalid coordinates

            return `
            <tr>
                <td>${index + 1}</td>
                <td>${sign.sign_name || ''}</td>
                <td>${sign.description || ''}</td>
                <td>${sign.lat_long}</td>
                <td>
                    <button class="zoom-btn" onclick="zoomToLocation(L.latLng(${lat}, ${lng}))"><i data-lucide="locate" class="w-3 h-3 inline"></i></button>
                     <button class="zoom-btn ml-1" onclick="openEditPanel('sign', ${sign.id || sign._row_num})"><i data-lucide="edit" class="w-3 h-3 inline"></i></button>
                </td>
            </tr>`;
        }).join('');

        // Re-initialize icons after table update
        lucide.createIcons();
    }

    // --- UI Interactions ---
    function zoomToLocation(latlng, zoomLevel = 18) {
        map.setView(latlng, zoomLevel);

        // Create blink effect
        const blinkMarker = L.circleMarker(latlng, {
            radius: 15,
            fillColor: '#ef4444',
            color: '#fff',
            weight: 3,
            fillOpacity: 0.8,
            opacity: 1
        }).addTo(map);

        let count = 0;
        const blinkInterval = setInterval(() => {
            blinkMarker.setStyle({
                opacity: blinkMarker.options.opacity === 1 ? 0 : 1,
                fillOpacity: blinkMarker.options.fillOpacity === 0.8 ? 0 : 0.8
            });
            count++;
            if (count >= 6) { // 3 blinks (on/off/on/off/on/off)
                clearInterval(blinkInterval);
                map.removeLayer(blinkMarker);
            }
        }, 300);
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        if (isEditMode) {
            activeTool = null; // Turn off capture tools
            document.getElementById('btn-building').classList.remove('active-tool');
            document.getElementById('btn-sign').classList.remove('active-tool');
            document.getElementById('btn-edit').classList.add('active-edit');
            // Enable dragging for all existing markers
            surveyLayers.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    enableMarkerDragging(layer, layer._popupData);
                }
            });
            showEditModeModal();
        } else {
            document.getElementById('btn-edit').classList.remove('active-edit');
            surveyLayers.eachLayer(l => l.dragging && l.dragging.disable());
        }
        // Reload markers/data to reflect draggability
        loadExistingData();
    }

    function showEditModeModal() {
        document.getElementById('edit-mode-modal').style.display = 'block';
    }

    function hideEditModeModal() {
        document.getElementById('edit-mode-modal').style.display = 'none';
    }

    function openEditPanel(type, rowId) {
         // Find the data object
         let dataObj = null;
         let dataArray = null;
         if (type === 'building') {
             dataObj = allBuildings.find(b => (b.id === rowId || b._row_num === rowId));
             dataArray = allBuildings;
         } else { // sign
             dataObj = allSigns.find(s => (s.id === rowId || s._row_num === rowId));
             dataArray = allSigns;
         }

         if (!dataObj) {
             showNotification('ไม่พบข้อมูล', 'error');
             return;
         }

         const panel = document.getElementById('side-panel');
         const contentDiv = document.getElementById('panel-content');
         const titleDiv = document.getElementById('panel-title');

         titleDiv.textContent = type === 'building' ? 'แก้ไขสิ่งปลูกสร้าง' : 'แก้ไขป้าย';

         // Simple form generation based on common fields
         // You should adapt this to match your exact Google Sheets column structure
         let formHTML = `
             <input type="hidden" id="edit-id" value="${dataObj.id || dataObj._row_num}">
             <input type="hidden" id="edit-type" value="${type}">

             <div class="form-group">
                 <label class="form-label">ชื่อเจ้าของ / ชื่อป้าย</label>
                 <input type="text" class="form-input" id="edit-owner-name" value="${dataObj.owner_name || dataObj.sign_name || ''}">
             </div>
             <div class="form-group">
                 <label class="form-label">พิกัด (Lat, Lng)</label>
                 <input type="text" class="form-input" id="edit-lat-lng" value="${dataObj.lat_long || ''}" readonly>
             </div>
             <div class="form-group">
                 <label class="form-label">รายละเอียด</label>
                 <textarea class="form-textarea" id="edit-description">${dataObj.description || dataObj.details || ''}</textarea>
             </div>
             <div class="form-group">
                 <label class="form-label">รูปภาพ (URL หรือ Base64)</label>
                 <input type="text" class="form-input" id="edit-image-url" value="${dataObj.image_url || ''}">
                  <img id="preview-image-edit" class="preview-image mt-2" style="display: ${dataObj.image_url ? 'block' : 'none'};" src="${dataObj.image_url || ''}" alt="Preview">
             </div>
             <button class="save-btn" onclick="saveEdits()">บันทึก</button>
             <button class="delete-btn" onclick="deleteEntry('${type}', ${dataObj.id || dataObj._row_num})">ลบข้อมูล</button>
         `;

         contentDiv.innerHTML = formHTML;
         lucide.createIcons(); // Initialize icons in the panel

         // Setup image preview for edit field
         document.getElementById('edit-image-url').addEventListener('input', function() {
             const imgPreview = document.getElementById('preview-image-edit');
             if (this.value) {
                 imgPreview.src = this.value;
                 imgPreview.style.display = 'block';
             } else {
                 imgPreview.style.display = 'none';
             }
         });

         panel.classList.add('active');

         // Store reference to the marker/data being edited
         // This is a simplified approach, ideally link directly to the marker if possible
         editingMarker = { data: dataObj, array: dataArray, index: dataArray.indexOf(dataObj) };
    }

    async function saveEdits() {
        if (!editingMarker) {
            showNotification('ไม่มีข้อมูลที่กำลังแก้ไข', 'error');
            return;
        }

        const id = document.getElementById('edit-id').value;
        const type = document.getElementById('edit-type').value;
        const ownerName = document.getElementById('edit-owner-name').value;
        const latLng = document.getElementById('edit-lat-lng').value;
        const description = document.getElementById('edit-description').value;
        const imageUrl = document.getElementById('edit-image-url').value;

        // Show saving indicator
        const panel = document.getElementById('side-panel');
        const saveBtn = panel.querySelector('.save-btn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'กำลังบันทึก...';
        saveBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('action', 'updateData');
            formData.append('id', id);
            formData.append('type', type);
            formData.append('owner_name', ownerName); // Adjust field names as per your GS setup
            formData.append('lat_long', latLng);
            formData.append('description', description); // Adjust field names as per your GS setup
            formData.append('image_url', imageUrl); // Adjust field names as per your GS setup

            const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
            const result = await res.json();

            if (result.result === 'success') {
                // Update local data stores and markers
                let dataArray = type === 'building' ? allBuildings : allSigns;
                let dataIndex = dataArray.findIndex(item => (item.id == id || item._row_num == id)); // Use == for potential string/number mismatch
                if (dataIndex !== -1) {
                    // Update the local object
                    dataArray[dataIndex].owner_name = ownerName;
                    dataArray[dataIndex].lat_long = latLng;
                    dataArray[dataIndex].description = description;
                    dataArray[dataIndex].image_url = imageUrl;

                    // Find and update the corresponding marker's popup and stored data
                    surveyLayers.eachLayer(marker => {
                        if (marker._popupData && (marker._popupData.id == id || marker._popupData._row_num == id)) {
                             // Update stored data reference
                             marker._popupData.owner_name = ownerName;
                             marker._popupData.lat_long = latLng;
                             marker._popupData.description = description;
                             marker._popupData.image_url = imageUrl;
                             // Refresh popup content
                             setupMarkerPopup(marker, marker._popupData, type);
                        }
                    });

                    showNotification('บันทึกข้อมูลสำเร็จ!', 'success');
                    closePanel();
                    // Reload tables to reflect changes
                    renderBuildingTable();
                    renderSignTable();
                } else {
                     showNotification('ไม่พบข้อมูลใน store ภายใน', 'error');
                }

            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error('Error saving edits:', err);
            showNotification(`บันทึกข้อมูลล้มเหลว: ${err.message}`, 'error');
        } finally {
            // Restore button state
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    }

    function closePanel() {
        document.getElementById('side-panel').classList.remove('active');
        editingMarker = null; // Clear reference
    }

    async function deleteEntry(type, rowId) {
        if (!confirm(`ต้องการลบข้อมูล ${type} นี้จริงหรือไม่?`)) return;

        try {
            const formData = new FormData();
            formData.append('action', 'deleteData');
            formData.append('id', rowId);
            formData.append('type', type);

            const res = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: formData });
            const result = await res.json();

            if (result.result === 'success') {
                // Remove from local data
                if (type === 'building') {
                    allBuildings = allBuildings.filter(b => !(b.id == rowId || b._row_num == rowId)); // Use == for potential mismatch
                } else {
                    allSigns = allSigns.filter(s => !(s.id == rowId || s._row_num == rowId));
                }

                // Remove marker from map
                surveyLayers.eachLayer(marker => {
                    if (marker._popupData && (marker._popupData.id == rowId || marker._popupData._row_num == rowId)) {
                         surveyLayers.removeLayer(marker);
                    }
                });

                showNotification('ลบข้อมูลสำเร็จ!', 'success');
                closePanel(); // Close panel after deletion
                // Reload tables
                renderBuildingTable();
                renderSignTable();
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error('Error deleting entry:', err);
            showNotification(`ลบข้อมูลล้มเหลว: ${err.message}`, 'error');
        }
    }

    // --- Export Functions ---
    async function exportGeoJSONForBuildings() {
       try {
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=exportGeoJSON&type=building`);
            const geojsonData = await res.json();
            if (geojsonData.type === 'FeatureCollection') {
                const blob = new Blob([JSON.stringify(geojsonData, null, 2)], { type: 'application/geo+json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `buildings_${new Date().toISOString().slice(0,10)}.geojson`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showNotification('ส่งออก GeoJSON สิ่งปลูกสร้าง สำเร็จ!', 'success');
            } else {
                throw new Error('Invalid GeoJSON received');
            }
        } catch (err) {
            console.error('Error exporting buildings:', err);
            showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูลสิ่งปลูกสร้าง', 'error');
        }
    }

    async function exportGeoJSONForSigns() {
       try {
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=exportGeoJSON&type=sign`);
            const geojsonData = await res.json();
            if (geojsonData.type === 'FeatureCollection') {
                const blob = new Blob([JSON.stringify(geojsonData, null, 2)], { type: 'application/geo+json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `signs_${new Date().toISOString().slice(0,10)}.geojson`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showNotification('ส่งออก GeoJSON ป้าย สำเร็จ!', 'success');
            } else {
                throw new Error('Invalid GeoJSON received');
            }
        } catch (err) {
            console.error('Error exporting signs:', err);
            showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูลป้าย', 'error');
        }
    }

    // Placeholder for image loading function
    async function loadBuildingImages() {
        // Implement logic to fetch image URLs from Google Drive folder using Apps Script
        // and potentially update local data or markers.
        // This requires setting up Apps Script to list and provide download links for images.
        showNotification('ฟังก์ชันนี้อยู่ระหว่างการพัฒนา', 'error');
    }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize map first
        initMap();

        // Register Service Worker for caching (only works on localhost or HTTPS)
        if ('serviceWorker' in navigator) {
            try {
                // Register the *new* sw.js file that handles tile caching
                await navigator.serviceWorker.register('/sw.js'); // Adjust path if necessary
                console.log('Service Worker registered for tile caching.');
            } catch (registrationError) {
                console.warn('SW registration failed:', registrationError);
                // Optionally inform the user that offline features won't work
                // showNotification('การลงทะเบียน Service Worker ล้มเหลว ระบบแคชออฟไลน์จะไม่ทำงาน', 'error');
            }
        } else {
             console.log('Service Worker not supported in this browser.');
             // Optionally inform the user
             // showNotification('เบราว์เซอร์นี้ไม่รองรับ Service Worker ระบบแคชออฟไลน์จะไม่ทำงาน', 'error');
        }

        // Initialize Lucide icons after DOM loads
        lucide.createIcons();

        // Attach event listeners
        document.getElementById('btn-building').addEventListener('click', () => activateTool('building'));
        document.getElementById('btn-sign').addEventListener('click', () => activateTool('sign'));
        document.getElementById('btn-refresh').addEventListener('click', loadExistingData);
        document.getElementById('btn-edit').addEventListener('click', toggleEditMode);
        document.getElementById('add-trigger').addEventListener('click', showConfirmOverlay);
        document.getElementById('btn-confirm-yes').addEventListener('click', confirmCapture);
        document.getElementById('btn-confirm-no').addEventListener('click', () => {
             document.getElementById('confirm-overlay').classList.remove('active');
             document.getElementById('confirm-overlay').classList.add('hidden');
        });
        document.querySelectorAll('.table-btn[data-type]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.currentTarget.getAttribute('data-type');
                currentTypeFilter = type;
                document.querySelectorAll('.table-btn').removeClass('active');
                e.currentTarget.classList.add('active');
                if (type === 'building') {
                    renderBuildingTable();
                } else {
                    renderSignTable();
                }
            });
        });
        document.getElementById('btn-export-geojson').addEventListener('click', exportGeoJSONForBuildings);
        document.getElementById('btn-export-sign-geojson').addEventListener('click', exportGeoJSONForSigns);
        document.getElementById('btn-load-images').addEventListener('click', loadBuildingImages);
        document.querySelector('.close-btn').addEventListener('click', closePanel);
        document.getElementById('btn-save-edits').addEventListener('click', saveEdits);
        document.getElementById('btn-cancel-edit').addEventListener('click', () => { hideEditModeModal(); loadExistingData(); }); // Refresh data on cancel

        // Helper for removing multiple classes
        NodeList.prototype.removeClass = HTMLCollection.prototype.removeClass = Array.prototype.removeClass = function(className) {
            this.forEach(el => el.classList.remove(className));
            return this;
        };

        // Load initial data
        await loadExistingData();
    });


    // Make functions available globally for inline onclick handlers
    window.zoomToLocation = zoomToLocation;
    window.openEditPanel = openEditPanel;
    window.closePanel = closePanel;
    window.saveEdits = saveEdits;
    window.deleteEntry = deleteEntry;
    window.exportGeoJSONForBuildings = exportGeoJSONForBuildings;
    window.exportGeoJSONForSigns = exportGeoJSONForSigns;
    window.loadBuildingImages = loadBuildingImages;
    window.toggleEditMode = toggleEditMode;
    window.deactivateTools = deactivateTools;

  </script>
</body>
</html>
